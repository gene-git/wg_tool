<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working Example 3 &#8212; wg_tool 8.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=e043c39a" />
    <script src="_static/documentation_options.js?v=f663eb4a"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-example-3">
<h1>Working Example 3<a class="headerlink" href="#working-example-3" title="Link to this heading">¶</a></h1>
<p>This example makes one small modification to <a class="reference internal" href="Examples.html#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
<p><em>wg-B</em> is changed to be a client instead of a gateway.</p>
<p>This means it no longer has its own <em>Endpoint</em>.
It continues to offer access to the Office B LAN but now
provides it to <em>wg-A</em> which in turn will share it with it’s clients.</p>
<p>This situation can occur when there are 2 locations, one of them
has a public IP address (<em>wg-A</em>) while the other one (<em>wg-B</em>) does not.
Now <em>wg-B</em> can connect to <em>wg-A</em> as a client, providing access to it’s LAN,
while <em>wg-A</em> offers its LAN to <em>wg-B</em>.</p>
<p>The road warrier laptops can only connect to <em>wg-A</em> and they all
want to have access to both LANs.</p>
<section id="network-diagram">
<h2>Network Diagram<a class="headerlink" href="#network-diagram" title="Link to this heading">¶</a></h2>
<a class="reference internal image-reference" href="_images/Example-3.png"><img alt="Example 3" class="align-center" src="_images/Example-3.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p><em>wg-B</em> will be a peer of <em>wg-A</em> and offer access to Office B’s LAN.
However clients will now access this LAN via <em>wq-A</em>.</p>
<p>Simple change to the goals, but quite a few changes to the wireguard configs.</p>
<p>When a gateway offers local networks
it is straightfoward to make them available to clients. In this case, clients need to
be informed that both Office A LAN and Office B LAN are available from gateway <em>wg-A</em>.</p>
<p>As before build the goals table:</p>
</section>
<section id="goals-table">
<h2>Goals Table<a class="headerlink" href="#goals-table" title="Link to this heading">¶</a></h2>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Example 3: vpn-test</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p><a href="#id2"><span class="problematic" id="id3">|ctron|</span></a> ✓ <a href="#id4"><span class="problematic" id="id5">|ctroff|</span></a></p></td>
<td><p><a href="#id6"><span class="problematic" id="id7">|ctron|</span></a> ✗ <a href="#id8"><span class="problematic" id="id9">|ctroff|</span></a></p></td>
<td><p><a href="#id10"><span class="problematic" id="id11">|ctron|</span></a> ✓ <a href="#id12"><span class="problematic" id="id13">|ctroff|</span></a></p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-B</p></td>
<td><p><a href="#id14"><span class="problematic" id="id15">|ctron|</span></a> ✗ <a href="#id16"><span class="problematic" id="id17">|ctroff|</span></a></p></td>
<td><p><a href="#id18"><span class="problematic" id="id19">|ctron|</span></a> ✗ <a href="#id20"><span class="problematic" id="id21">|ctroff|</span></a></p></td>
<td><p><a href="#id22"><span class="problematic" id="id23">|ctron|</span></a> ✗ <a href="#id24"><span class="problematic" id="id25">|ctroff|</span></a></p></td>
<td><p>192.168.2.0/24</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id26"><span class="problematic" id="id27">|ctron|</span></a> ✗ <a href="#id28"><span class="problematic" id="id29">|ctroff|</span></a></p></td>
<td><p><a href="#id30"><span class="problematic" id="id31">|ctron|</span></a> ✓ <a href="#id32"><span class="problematic" id="id33">|ctroff|</span></a></p></td>
<td><p><a href="#id34"><span class="problematic" id="id35">|ctron|</span></a> ✗ <a href="#id36"><span class="problematic" id="id37">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id38"><span class="problematic" id="id39">|ctron|</span></a> ✗ <a href="#id40"><span class="problematic" id="id41">|ctroff|</span></a></p></td>
<td><p><a href="#id42"><span class="problematic" id="id43">|ctron|</span></a> ✓ <a href="#id44"><span class="problematic" id="id45">|ctroff|</span></a></p></td>
<td><p><a href="#id46"><span class="problematic" id="id47">|ctron|</span></a> ✗ <a href="#id48"><span class="problematic" id="id49">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id50"><span class="problematic" id="id51">|ctron|</span></a> ✗ <a href="#id52"><span class="problematic" id="id53">|ctroff|</span></a></p></td>
<td><p><a href="#id54"><span class="problematic" id="id55">|ctron|</span></a> ✗ <a href="#id56"><span class="problematic" id="id57">|ctroff|</span></a></p></td>
<td><p><a href="#id58"><span class="problematic" id="id59">|ctron|</span></a> ✗ <a href="#id60"><span class="problematic" id="id61">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
</tbody>
</table>
</section>
<section id="generating-the-wireguard-configs-using-wg-tool">
<h2>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#generating-the-wireguard-configs-using-wg-tool" title="Link to this heading">¶</a></h2>
<p>As in the previous two examples, we create the wireguard configs
using wg-tool. We are going to make a small edit to <em>wg-B</em> to achieve this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-B
</pre></div>
</div>
<p>Edit the file as before, (<em>Edits/vpn-test.servers.wg-B.mods</em>).
The only change needed is to set <em>Endpoint</em> to an empty string
and change <em>internet_offered</em> to false</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;&quot;
internet_offered = false
</pre></div>
</div>
<p>Merge the changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-B.mods
</pre></div>
</div>
<p>Since <em>wg-B</em> can no longer provide access to other clients, we let <em>wg-A</em>
do that on it’s behalf:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-offered-add<span class="w">  </span><span class="s1">&#39;192.168.2.0/24&#39;</span><span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>That should be all that is necessary, <em>wg-tool</em> will do the rest.</p>
<p>List what we have:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>The only real difference in the listing is that <em>wg-B</em> is no longer showing
as a gateway. It isn’t of course, its just another peer at this point.
However, it still provides access to the <em>192.168.2.0/24</em> network.</p>
<p>Here’s a terminal screen shot of the output:</p>
<a class="reference internal image-reference" href="_images/Example-3-list.png"><img alt="Example 3" class="align-center" src="_images/Example-3-list.png" style="width: 858.0px; height: 553.0px;" />
</a>
<p>As you can see in the verbose list output, <em>wg-B</em> is no longer a gateway. It offers
access to Office B LAN as a client to <em>wg-A</em>. It also <em>wants</em> access to Office A LAN.</p>
<p>All laptops want access to both networks which they now get from <em>wg-A</em>.</p>
<p>If you look at the wireguard configs you will see that the laptops now get both
networks from <em>wg-A</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-A.conf
cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-B.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-1/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-2/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-3/laptop.conf
</pre></div>
</div>
<p>You will see that <em>wg-B</em> now has just one peer which is <em>wg-A</em>.
Furthermore, <em>wg-A</em> now allows <em>192.168.1.0/24</em> as well as <em>192.168.2.0/24</em> to it’s
clients. Finally, all the laptop clients now have both LANs listed in each
<em>AllowedIPs</em> with <em>wg-A</em>.</p>
<p>Previously, each laptop had LAN A listed for <em>wg-A</em> and LAN B for <em>wg-B</em>.</p>
<p>If we want to go back with <em>wg-B</em> again being a full gateway, then we just
edit <em>wg-B</em> and restore it’s Endpoint and, if desired,  allow it to offer
internet access as well.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_B.example.net:51820&quot;
internet_offered = true
</pre></div>
</div>
<p>Merge changes back and everything is back to the way it was in <a class="reference internal" href="Examples.html#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
</section>
<section id="standard-wireguard-configs">
<span id="example-3-standard"></span><h2>Standard Wireguard Configs<a class="headerlink" href="#standard-wireguard-configs" title="Link to this heading">¶</a></h2>
<p>The basic set up is same as example 2. The only thing we’re changing, at
least superficially, is that <em>wg-B</em> is no longer a gateway; it’s now another client.</p>
<p>This alsop means other client configs must be changed that they know to access
Office B LAN from <em>wg-A</em> instead of <em>wg-B</em>, as before.</p>
<p>We must also change <em>wg-B</em> to remove the Endpoint while still offering
LAN-B access.</p>
<p><strong>wg-A</strong></p>
<ul class="simple">
<li><p>Note that the Peer section for <em>wg-B</em> no longer has an Endpoint</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset


#
# Clients
#

[Peer]               # servers wg-B
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::5/128

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::4/128
</pre></div>
</div>
<p><strong>wg-B</strong></p>
<ul class="simple">
<li><p>Client not a gateway</p></li>
<li><p>ListenPort is removed from the Interface section,</p></li>
<li><p>provides access to LAN B</p></li>
<li><p>there are no longer any user laptop sections</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-B
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.5/32, fc00:77:77::5/128
    DNS                  = 10.10.10.10
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-1</strong></p>
<ul class="simple">
<li><p>Note <em>wg-B</em> has been removed from all laptop clients and Office B LAN now provided by <em>wg-A</em></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">wg_tool</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="README.html">wg-tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#getting-started">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="License/License.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="Examples.html">Working Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Editing.html">Editing and Making Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Options.html">Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Reports.html">Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Key-rollover.html">Key Rollover</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Helper-scripts.html">Convenience Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Migrating.html">Migrating from Earlier Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Import.html">Importing From Standard Wireguard Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Directory-structure.html">Directory and File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contrib/ubuntu.html">Contrib</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022-2025, Gene C.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/Example-3.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>