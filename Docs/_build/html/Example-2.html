<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working Example 2 &#8212; wg_tool 8.0.rc2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=e043c39a" />
    <script src="_static/documentation_options.js?v=321254cf"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-example-2">
<span id="example-2"></span><h1>Working Example 2<a class="headerlink" href="#working-example-2" title="Link to this heading">¶</a></h1>
<p>This example builds on <a class="reference internal" href="Examples.html#example-1"><span class="std std-ref">Working Example 1</span></a> by adding second gateway.</p>
<p>The new gateway <em>wg-B</em> provides access to Office-B LAN, <em>192.168.2.0/24</em>.
Both gateways provide internet access and are visible on the internet.</p>
<p><em>wg-A</em> still offers access to  Office A LAN.</p>
<p>We walk through the steps <a class="reference internal" href="Examples.html#example-2-tool"><span class="std std-ref">Generating the Wireguard Configs Using wg-tool</span></a> which leads to the
creation of the <a class="reference internal" href="Examples.html#example-2-standard"><span class="std std-ref">Standard Wireguard Configs</span></a>.</p>
<section id="network-diagram">
<h2>Network Diagram<a class="headerlink" href="#network-diagram" title="Link to this heading">¶</a></h2>
<a class="reference internal image-reference" href="_images/Example-2.png"><img alt="Example 2" class="align-center" src="_images/Example-2.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p>user-1 and user-2’s laptops can connect to both gateways and
access both LANs. Their internet traffic will go through the vpn, providing
privacy. Their internet access could be one or the other gateway.</p>
<p>Note that wireguard relies on the networks shown in the config files
to set up routing. It does not check nor provide a failover mechanism
or any dynamic checks and adjustments.</p>
<p>In practice wireguard chooses the first peer offering a route to the internet
and stick with that. This happens when wireguard starts.</p>
<p>user-3 continues to use split routing, retaining direct internet access and using
the gateways solely for LAN access to both office locations.</p>
<p>As in the previous example, we construct the goals table:</p>
</section>
<section id="goals-table">
<h2>Goals Table<a class="headerlink" href="#goals-table" title="Link to this heading">¶</a></h2>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Example 2 Goals</span><a class="headerlink" href="#id5" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p><a href="#id7"><span class="problematic" id="id8">|ctron|</span></a> ✓ <a href="#id9"><span class="problematic" id="id10">|ctroff|</span></a></p></td>
<td><p><a href="#id11"><span class="problematic" id="id12">|ctron|</span></a> ✗ <a href="#id13"><span class="problematic" id="id14">|ctroff|</span></a></p></td>
<td><p><a href="#id15"><span class="problematic" id="id16">|ctron|</span></a> ✓ <a href="#id17"><span class="problematic" id="id18">|ctroff|</span></a></p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>servers</p></td>
<td><p>wg-B</p></td>
<td><p><a href="#id19"><span class="problematic" id="id20">|ctron|</span></a> ✓ <a href="#id21"><span class="problematic" id="id22">|ctroff|</span></a></p></td>
<td><p><a href="#id23"><span class="problematic" id="id24">|ctron|</span></a> ✗ <a href="#id25"><span class="problematic" id="id26">|ctroff|</span></a></p></td>
<td><p><a href="#id27"><span class="problematic" id="id28">|ctron|</span></a> ✓ <a href="#id29"><span class="problematic" id="id30">|ctroff|</span></a></p></td>
<td><p>192.168.2.0/24</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id31"><span class="problematic" id="id32">|ctron|</span></a> ✗ <a href="#id33"><span class="problematic" id="id34">|ctroff|</span></a></p></td>
<td><p><a href="#id35"><span class="problematic" id="id36">|ctron|</span></a> ✓ <a href="#id37"><span class="problematic" id="id38">|ctroff|</span></a></p></td>
<td><p><a href="#id39"><span class="problematic" id="id40">|ctron|</span></a> ✗ <a href="#id41"><span class="problematic" id="id42">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id43"><span class="problematic" id="id44">|ctron|</span></a> ✗ <a href="#id45"><span class="problematic" id="id46">|ctroff|</span></a></p></td>
<td><p><a href="#id47"><span class="problematic" id="id48">|ctron|</span></a> ✓ <a href="#id49"><span class="problematic" id="id50">|ctroff|</span></a></p></td>
<td><p><a href="#id51"><span class="problematic" id="id52">|ctron|</span></a> ✗ <a href="#id53"><span class="problematic" id="id54">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id55"><span class="problematic" id="id56">|ctron|</span></a> ✗ <a href="#id57"><span class="problematic" id="id58">|ctroff|</span></a></p></td>
<td><p><a href="#id59"><span class="problematic" id="id60">|ctron|</span></a> ✗ <a href="#id61"><span class="problematic" id="id62">|ctroff|</span></a></p></td>
<td><p><a href="#id63"><span class="problematic" id="id64">|ctron|</span></a> ✗ <a href="#id65"><span class="problematic" id="id66">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
</tbody>
</table>
</section>
<section id="generating-the-wireguard-configs-using-wg-tool">
<span id="example-2-tool"></span><h2>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#generating-the-wireguard-configs-using-wg-tool" title="Link to this heading">¶</a></h2>
<p>Next we create the wireguard configs above using wg-tool.
This will be quit a bit simpler than editing all those configs manually.</p>
<p>We build on what was done in Part 1 working in the same directory.</p>
<section id="add-second-gateway-wg-b">
<h3>Add Second Gateway wg-B<a class="headerlink" href="#add-second-gateway-wg-b" title="Link to this heading">¶</a></h3>
<p>Lets add the new gateway <em>wg-B</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--new<span class="w"> </span>vpn-test.servers.wg-B
wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-B
</pre></div>
</div>
<p>Edit the file as displayed, this time it will be <em>Edits/vpn-test.servers.wg-B.mods</em>.</p>
<p>As we did for <em>wg-A</em>, add an Endpoint for <em>wg-B</em>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_B.example.net:51820&quot;]
internet_offered = true
post_up = [&#39;/usr/bin/nft -f /etc/wireguard/scripts/postup.nft&#39;]
post_down = [&#39;/usr/bin/nft flush ruleset&#39;]
</pre></div>
</div>
<p>As before merge the changes back:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-B.mods
</pre></div>
</div>
</section>
<section id="network-access">
<h3>Network Access<a class="headerlink" href="#network-access" title="Link to this heading">¶</a></h3>
<p>First lets set <em>wg-B</em> to offer Ofice B LAN network, <em>192.168.2.0/24</em>, and
also give it access to the LAN offered by <em>wg-A</em> network.</p>
<p>We’ll also give <em>wg-A</em> access to this network, <em>192.168.2.0/24</em>.</p>
<p>I other words, each of the 2 gateways will have access to the LAN provided
by the other gateway.</p>
<p>Lets use the command line options to accomplish this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-offered-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-B
wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.1.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-B

wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>Next we add permission to <em>192.168.2.0/24</em> for all 3 user profiles.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.user-1<span class="w"> </span>vpn-test.user-2<span class="w"> </span>vpn-test.user-3
</pre></div>
</div>
<p>Notice that we used <em>&lt;vpn&gt;.&lt;account&gt;</em> for the user IDs. This is a shortcut for every profile
belonging to <em>&lt;vpn&gt;.&lt;account&gt;</em>. In our case each user only has a single profile, laptop.
If there were more then, every profile would have this network added.</p>
<p>You can add multiple networks using <em>–nets-wanted-add</em> by separating them with commas.
For example you can use “102.168.2.0/24,192.168.100.0/24” to add 2 networks.</p>
</section>
<section id="listing-what-we-have">
<h3>Listing What We Have<a class="headerlink" href="#listing-what-we-have" title="Link to this heading">¶</a></h3>
<p>As we did in previous example, lets list everthing to confirm it has what we want.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>Output should look similar to this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>✓ vpn-test         250915-065904:

    ✓ servers      250915-093519:
                     ✓ wg-A                 250915-093526 (gateway)
                                     nets_offered : [&#39;192.168.1.0/24&#39;, &#39;internet&#39;]
                                      nets_wanted : [&#39;192.168.2.0/24&#39;]
                     ✓ wg-B                 250915-093526 (gateway)
                                     nets_offered : [&#39;192.168.2.0/24&#39;, &#39;internet&#39;]
                                      nets_wanted : [&#39;192.168.1.0/24&#39;]

    ✓ user-1       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;192.168.2.0/24&#39;, &#39;internet&#39;]

    ✓ user-2       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;192.168.2.0/24&#39;, &#39;internet&#39;]

    ✓ user-3       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.32/28&#39;, &#39;192.168.2.0/24&#39;]
</pre></div>
</div>
<p>This shows both gateways sharing one another’s networks
and the users have also gained access to <em>192.168.2.0/24</em></p>
<p><em>vpn-test.user-3.laptop</em> is still using split tunnelling.</p>
<p>As before, the resulting wireguard config files reside
under <em>Data-wg/vpn-test1</em>.</p>
<p>By now you may feel the list output above is sufficient to confirm things
are as intended, but for completeness we’ll show the resulting wireguard
configs, as we did in the previous example.</p>
<p>The config for the 2 gateways <em>wg-A</em> and <em>wg-B</em> will be in:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-A.conf
cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-B.conf
</pre></div>
</div>
<p>while the 3 user acoounts and their laptop profiles will be found:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat Data-wg/vpn-test/user-1/laptop.conf
cat Data-wg/vpn-test/user-2/laptop.conf
cat Data-wg/vpn-test/user-3/laptop.conf
</pre></div>
</div>
<p>These files should match what is shown below.</p>
</section>
</section>
<section id="standard-wireguard-configs">
<span id="example-2-standard"></span><h2>Standard Wireguard Configs<a class="headerlink" href="#standard-wireguard-configs" title="Link to this heading">¶</a></h2>
<p><strong>wg-A</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::5/128
    Endpoint             = vpn_B.example.com:51820

#
# Clients
#

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.0/24, fc00:77:77::4/128
</pre></div>
</div>
<p><strong>wg-B</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-B (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.5/24, fc00:77:77::5/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-B x wg-A&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820

#
# Clients
#

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.2.0/24, fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.2.0/24, fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.2.0/24, fc00:77:77::4/128
</pre></div>
</div>
<p><strong>user-1</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.5/32, 192.168.2.0/24
    # pre-compacted        ::/0, fc00:77:77::5/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-2.laptop&gt;
    # re-compacted        0.0.0.0/0, 10.77.77.5/32, 192.168.2.0/24
    # re-compacted        ::/0, fc00:77:77::5/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#
[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.2.0/24, fc00:77:77::5/128
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
</section>
</section>
<section id="working-example-3">
<h1>Working Example 3<a class="headerlink" href="#working-example-3" title="Link to this heading">¶</a></h1>
<p>This example makes one small modification to <a class="reference internal" href="Examples.html#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
<p><em>wg-B</em> is changed to be a client instead of a gateway.</p>
<p>This means it no longer has its own <em>Endpoint</em>.
It continues to offer access to the Office B LAN but now
provides it to <em>wg-A</em> which in turn will share it with it’s clients.</p>
<p>This situation can occur when there are 2 locations, one of them
has a public IP address (<em>wg-A</em>) while the other one (<em>wg-B</em>) does not.
Now <em>wg-B</em> can connect to <em>wg-A</em> as a client, providing access to it’s LAN,
while <em>wg-A</em> offers its LAN to <em>wg-B</em>.</p>
<p>The road warrier laptops can only connect to <em>wg-A</em> and they all
want to have access to both LANs.</p>
<section id="id1">
<h2>Network Diagram<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<a class="reference internal image-reference" href="_images/Example-3.png"><img alt="Example 3" class="align-center" src="_images/Example-3.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p><em>wg-B</em> will be a peer of <em>wg-A</em> and offer access to Office B’s LAN.
However clients will now access this LAN via <em>wq-A</em>.</p>
<p>Simple change to the goals, but quite a few changes to the wireguard configs.</p>
<p>When a gateway offers local networks
it is straightfoward to make them available to clients. In this case, clients need to
be informed that both Office A LAN and Office B LAN are available from gateway <em>wg-A</em>.</p>
<p>As before build the goals table:</p>
</section>
<section id="id2">
<h2>Goals Table<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<table class="docutils align-default" id="id6">
<caption><span class="caption-text">Example 3: vpn-test</span><a class="headerlink" href="#id6" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p><a href="#id67"><span class="problematic" id="id68">|ctron|</span></a> ✓ <a href="#id69"><span class="problematic" id="id70">|ctroff|</span></a></p></td>
<td><p><a href="#id71"><span class="problematic" id="id72">|ctron|</span></a> ✗ <a href="#id73"><span class="problematic" id="id74">|ctroff|</span></a></p></td>
<td><p><a href="#id75"><span class="problematic" id="id76">|ctron|</span></a> ✓ <a href="#id77"><span class="problematic" id="id78">|ctroff|</span></a></p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-B</p></td>
<td><p><a href="#id79"><span class="problematic" id="id80">|ctron|</span></a> ✗ <a href="#id81"><span class="problematic" id="id82">|ctroff|</span></a></p></td>
<td><p><a href="#id83"><span class="problematic" id="id84">|ctron|</span></a> ✗ <a href="#id85"><span class="problematic" id="id86">|ctroff|</span></a></p></td>
<td><p><a href="#id87"><span class="problematic" id="id88">|ctron|</span></a> ✗ <a href="#id89"><span class="problematic" id="id90">|ctroff|</span></a></p></td>
<td><p>192.168.2.0/24</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id91"><span class="problematic" id="id92">|ctron|</span></a> ✗ <a href="#id93"><span class="problematic" id="id94">|ctroff|</span></a></p></td>
<td><p><a href="#id95"><span class="problematic" id="id96">|ctron|</span></a> ✓ <a href="#id97"><span class="problematic" id="id98">|ctroff|</span></a></p></td>
<td><p><a href="#id99"><span class="problematic" id="id100">|ctron|</span></a> ✗ <a href="#id101"><span class="problematic" id="id102">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id103"><span class="problematic" id="id104">|ctron|</span></a> ✗ <a href="#id105"><span class="problematic" id="id106">|ctroff|</span></a></p></td>
<td><p><a href="#id107"><span class="problematic" id="id108">|ctron|</span></a> ✓ <a href="#id109"><span class="problematic" id="id110">|ctroff|</span></a></p></td>
<td><p><a href="#id111"><span class="problematic" id="id112">|ctron|</span></a> ✗ <a href="#id113"><span class="problematic" id="id114">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p><a href="#id115"><span class="problematic" id="id116">|ctron|</span></a> ✗ <a href="#id117"><span class="problematic" id="id118">|ctroff|</span></a></p></td>
<td><p><a href="#id119"><span class="problematic" id="id120">|ctron|</span></a> ✗ <a href="#id121"><span class="problematic" id="id122">|ctroff|</span></a></p></td>
<td><p><a href="#id123"><span class="problematic" id="id124">|ctron|</span></a> ✗ <a href="#id125"><span class="problematic" id="id126">|ctroff|</span></a></p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id3">
<h2>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>As in the previous two examples, we create the wireguard configs
using wg-tool. We are going to make a small edit to <em>wg-B</em> to achieve this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-B
</pre></div>
</div>
<p>Edit the file as before, (<em>Edits/vpn-test.servers.wg-B.mods</em>).
The only change needed is to set <em>Endpoint</em> to an empty string
and change <em>internet_offered</em> to false</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;&quot;
internet_offered = false
</pre></div>
</div>
<p>Merge the changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-B.mods
</pre></div>
</div>
<p>Since <em>wg-B</em> can no longer provide access to other clients, we let <em>wg-A</em>
do that on it’s behalf:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-offered-add<span class="w">  </span><span class="s1">&#39;192.168.2.0/24&#39;</span><span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>That should be all that is necessary, <em>wg-tool</em> will do the rest.</p>
<p>List what we have:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>The only real difference in the listing is that <em>wg-B</em> is no longer showing
as a gateway. It isn’t of course, its just another peer at this point.
However, it still provides access to the <em>192.168.2.0/24</em> network.</p>
<p>Here’s a terminal screen shot of the output:</p>
<a class="reference internal image-reference" href="_images/Example-3-list.png"><img alt="Example 3" class="align-center" src="_images/Example-3-list.png" style="width: 858.0px; height: 553.0px;" />
</a>
<p>As you can see in the verbose list output, <em>wg-B</em> is no longer a gateway. It offers
access to Office B LAN as a client to <em>wg-A</em>. It also <em>wants</em> access to Office A LAN.</p>
<p>All laptops want access to both networks which they now get from <em>wg-A</em>.</p>
<p>If you look at the wireguard configs you will see that the laptops now get both
networks from <em>wg-A</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-A.conf
cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-B.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-1/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-2/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-3/laptop.conf
</pre></div>
</div>
<p>You will see that <em>wg-B</em> now has just one peer which is <em>wg-A</em>.
Furthermore, <em>wg-A</em> now allows <em>192.168.1.0/24</em> as well as <em>192.168.2.0/24</em> to it’s
clients. Finally, all the laptop clients now have both LANs listed in each
<em>AllowedIPs</em> with <em>wg-A</em>.</p>
<p>Previously, each laptop had LAN A listed for <em>wg-A</em> and LAN B for <em>wg-B</em>.</p>
<p>If we want to go back with <em>wg-B</em> again being a full gateway, then we just
edit <em>wg-B</em> and restore it’s Endpoint and, if desired,  allow it to offer
internet access as well.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_B.example.net:51820&quot;
internet_offered = true
</pre></div>
</div>
<p>Merge changes back and everything is back to the way it was in <a class="reference internal" href="Examples.html#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
</section>
<section id="example-3-standard">
<span id="id4"></span><h2>Standard Wireguard Configs<a class="headerlink" href="#example-3-standard" title="Link to this heading">¶</a></h2>
<p>The basic set up is same as example 2. The only thing we’re changing, at
least superficially, is that <em>wg-B</em> is no longer a gateway; it’s now another client.</p>
<p>This alsop means other client configs must be changed that they know to access
Office B LAN from <em>wg-A</em> instead of <em>wg-B</em>, as before.</p>
<p>We must also change <em>wg-B</em> to remove the Endpoint while still offering
LAN-B access.</p>
<p><strong>wg-A</strong></p>
<ul class="simple">
<li><p>Note that the Peer section for <em>wg-B</em> no longer has an Endpoint</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset


#
# Clients
#

[Peer]               # servers wg-B
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::5/128

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::4/128
</pre></div>
</div>
<p><strong>wg-B</strong></p>
<ul class="simple">
<li><p>Client not a gateway</p></li>
<li><p>ListenPort is removed from the Interface section,</p></li>
<li><p>provides access to LAN B</p></li>
<li><p>there are no longer any user laptop sections</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-B
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.5/32, fc00:77:77::5/128
    DNS                  = 10.10.10.10
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-1</strong></p>
<ul class="simple">
<li><p>Note <em>wg-B</em> has been removed from all laptop clients and Office B LAN now provided by <em>wg-A</em></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">wg_tool</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="README.html">wg-tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#getting-started">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="License/License.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="Examples.html">Working Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Editing.html">Editing and Making Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Options.html">Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Reports.html">Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Key-rollover.html">Key Rollover</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Helper-scripts.html">Convenience Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Migrating.html">Migrating from Earlier Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Import.html">Importing From Standard Wireguard Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Directory-structure.html">Directory and File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contrib/ubuntu.html">Contrib</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022-2025, Gene C.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/Example-2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>