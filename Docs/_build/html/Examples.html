<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working Examples &#8212; wg_tool 8.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=e043c39a" />
    <script src="_static/documentation_options.js?v=15c97ff8"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Editing and Making Changes" href="Sections/Editing.html" />
    <link rel="prev" title="License" href="License/License.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section class="centered-table-text" id="working-examples">
<span id="examples"></span><h1>Working Examples<a class="headerlink" href="#working-examples" title="Link to this heading">¶</a></h1>
<p>Working examples often provide a good learning path. Here we offer three
such examples, each offering a step by step
illustration how to achieve each goal.</p>
<p>In each case, we lay out the goal and then walk through using
<em>wg-tool</em> to achieve that goal.</p>
<p>At the end the generated standard wireguard configs are shown.</p>
<p>The first example is the simplest with a single gateway, A, and some
road warrier clients.  The gateway provides it’s clients with access to
Office A LAN and an option for their internet traffic to go via the
gateway.</p>
<p>The second example extends this adding a second gateway, B.
This new gateway provides access to a second Office LAN.
Clients now access Offie A’s LAN via gateway A and Office
B’s LAN via gateway B.</p>
<p>The last example modifies gateway B to be a client. This client connects
to gateway A and still provides Office B LAN access but now only to gateway A
which in turn offers access to it’s own clients.</p>
<p>Gateway A is now able to provide access for road warrier clients to
both LAN A and LAN B with help from <em>client B</em>.</p>
<p>I would encourage you to work through the examples. But,
if you want to quickly see the results of doing the examples, there are
scripts in the examples directory that do it for you.
The scripts generate the data in the same directory they are run in.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>create-example-1
create-example-2
create-example-3
</pre></div>
</div>
<p>These can be run sequentially starting with <em>create-example-1</em>.
You can then run <em>create-example-2</em> and <em>create-example-3</em>. After each step
you may want to look at the outputs saved under <em>Data-wg</em> and get
a summary using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<section id="where-to-run-the-gateway">
<h2>Where to Run The Gateway<a class="headerlink" href="#where-to-run-the-gateway" title="Link to this heading">¶</a></h2>
<p>While gateways can be run on a firewall / border router, we prefer to run them
behind the firewall, where the firewall forwards necesary UDP port.</p>
<p>The reason we like this approach is that firewall rules used by the gateway
don’t have to be concerned about any existing firewall rules, as is the case
when gateway runs on the firewall itself. It’s also a little cleaner from a security
perspective to minimize what runs on the firewall.</p>
<p>One downside putting the vpn behind the firewall is that internal hosts
wishing to use the gateway, may need additional routes.</p>
<p>For example, if LAN-A clients wish to access LAN-B, they will
need a route to the appropriate vpn gateway to allow this.</p>
<p>In contrast, when the vpn runs on the firewall, since the firewall
is typically the default route, additional routes may not be needed.</p>
<p>Adding static routes in linux is straightforward.</p>
<p>For DHCP, ISC’s Kea supports
classless static routing <a class="footnote-reference brackets" href="#rfc3442" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. In Kea this takes a list of routes, each of the
form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>network - IP-address
</pre></div>
</div>
<p>which signifies that the route to <em>network</em> is provided by <em>IP-address</em>.
Per the RFC this option supercedes the older routers option
and thus all routes should be listed in addition to having the older option.</p>
<p>If the gateway runs on the firewall, and LAN clients have a default route to the firewall,
then it all works without any additional route.</p>
<p>For the working examples, exactly where the gateways run plays no role at all.</p>
<p>On to the examples!</p>
</section>
<section id="working-example-1">
<span id="example-1"></span><h2>Working Example 1<a class="headerlink" href="#working-example-1" title="Link to this heading">¶</a></h2>
<p>This example has a single wireguard gateway, <em>wg-A</em>, providing access to Office-A
internal LAN, <em>192.168.1.0/24</em> to it’s clients. It also offers internet access for
any clients wanting all internet traffic to go through the vpn.</p>
<p>This expands on the rather <a class="reference internal" href="README.html#simple-example"><span class="std std-ref">Simple Example</span></a> shown earlier.</p>
<p>As we do in all the examples, we first walk through
<a class="reference internal" href="#example-1-tool"><span class="std std-ref">Generating the Wireguard Configs Using wg-tool</span></a>.</p>
<p>At the end of the walk throgh, we show the resulting <a class="reference internal" href="#example-1-standard"><span class="std std-ref">Standard Wireguard Configs</span></a> that are created.
In this example the result will be the gateway and it’s client configs.
Client configs come with a QR code carrying the same information.</p>
<p>These configs are the ones consumed by wireguard itself.</p>
<section id="network-diagram">
<h3>Network Diagram<a class="headerlink" href="#network-diagram" title="Link to this heading">¶</a></h3>
<a class="reference internal image-reference" href="_images/Example-1.png"><img alt="Example 1" class="align-center" src="_images/Example-1.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p>We find it helpful to make a small table with the goals for this vpn.</p>
<p>The table lists each of the peers and what they want from or offer to other peers.</p>
<p>Gateways are those peers which other connect to.
All gateways are marked.  Some gateways may provide internet access.</p>
<p>Some peers may offer network access to specific networks.</p>
<p>Some clients may want their internet traffic to flow through the vpn while
others may want to access the internet directly and use the vpn soley to
access internal networks.</p>
<p>For all examples we use a vpn named <em>vpn-test</em>.</p>
</section>
<section id="goals-table">
<h3>Goals Table<a class="headerlink" href="#goals-table" title="Link to this heading">¶</a></h3>
<table class="docutils align-default" id="id14">
<caption><span class="caption-text">Example 1 Goals</span><a class="headerlink" href="#id14" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-even"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
</tbody>
</table>
<p><em>wg-A</em> also offers internet access to it’s peers. Some peers, such as <em>user-3.laptop</em>
may prefer to access the internet directly and only use <em>wg-A</em> to access <em>LAN-A</em>.</p>
<p><em>user-3.laptop</em> is using <em>split routing</em> (also called <em>split tunnelling</em>),
since it routes <em>LAN-A</em> traffic over the VPN, while all other traffic goes direct.</p>
<p><em>user-1.laptop</em>, on the other hand has all of it’s network traffic go
via <em>wg-A</em>.</p>
<p>In this example we use the following networks:</p>
<ul class="simple">
<li><p><em>vpn.example.com:51820</em> : Endpoint of gateway <em>wg-A</em></p></li>
<li><p><em>10.77.77.0/24</em> : vpn internal network.</p></li>
<li><p><em>192.168.1.0/24</em> : <em>LAN-A</em> the internal Office A LAN.</p></li>
</ul>
</section>
<section id="generating-the-wireguard-configs-using-wg-tool">
<span id="example-1-tool"></span><h3>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#generating-the-wireguard-configs-using-wg-tool" title="Link to this heading">¶</a></h3>
<p>This is a step by step walk through using the tool to create the configs
that wireguard uses. Once done you can browse the configs that result.</p>
<p>Please never edit any files in Data/. To make a change,
or to view the editable variables, use <em>wg-tool –edit &lt;ID&gt;</em>.</p>
<p>That saves a file in the Edits/ directory which you can edit
and, if you so choose, merge any changes back with <em>wg-tool –merge &lt;file&gt;</em>.</p>
<p>To create your own example, work in an empty directory of your choosing.
First create a “vpn” group hich we’ll label <em>vpn-test</em> here. This contains
all related wireguard peers. A peer can be a gateway or a client.</p>
<p>Each peer is is denoted by an identifier which takes the form:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;vpn name&gt;.&lt;account name&gt;.&lt;profile name&gt;
</pre></div>
</div>
<p>Names are alphanumeric, with some restrictions on special characters <a class="footnote-reference brackets" href="#valid-names" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.
For example periods are not allowed (for obvious reasons).</p>
<p>We find it convenient to use <em>servers</em> for
the <em>account name</em> for things that run on a server, like gateways.
User names make a good account name choice for people.</p>
<p>There are some instances where an ID may be shortened. For example to
create a new vpn, we can drop account and/or profile part.
Later we use the full ID to create gateway and client profiles.</p>
<section id="make-working-directory">
<h4>Make Working Directory<a class="headerlink" href="#make-working-directory" title="Link to this heading">¶</a></h4>
<p>The first step is to establish a working directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>my-examples
<span class="nb">cd</span><span class="w"> </span>my-examples
wg-tool<span class="w"> </span>-wkd<span class="w"> </span>./
</pre></div>
</div>
<p>Note that networks in the <em>AllowedIPs</em> wireguard config
are compacted to their minimal CIDR representation. The pre-compacted
list, perhaps most useful during testing, is provded as a comment in the config file.
For additional information please see <a class="reference internal" href="Sections/Options.html#compacting"><span class="std std-ref">Compacting Networks</span></a>.</p>
</section>
<section id="make-new-vpn-called-vpn-test">
<h4>Make New VPN called vpn-test<a class="headerlink" href="#make-new-vpn-called-vpn-test" title="Link to this heading">¶</a></h4>
<p>We now create a new vpn named <em>vpn-test</em>. For this the ID is simply <em>vpn-test</em>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-new<span class="w"> </span>vpn-test
</pre></div>
</div>
<p>This also invokes the <em>edit</em> option and displays the file name.
This file will be ./Edits/vpn-test-info.mods.</p>
<p>Please edit this file and add any relevant VPN information.
In our case we really may only need to add a DNS server (or 2), host or IP.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dns = [&#39;10.10.10.10&#39;]
peer_to_peer = false
</pre></div>
</div>
<p>Note that elements in <em>dns</em> are dns servers. They can be an IP address
or a hostname; hostnames will be converted to their IP address
using local dns resolver.</p>
<p>For more information about DNS please see <a class="reference internal" href="Sections/Editing.html#dns-note"><span class="std std-ref">Note On DNS</span></a>.</p>
<p>You can change the internal tunnel network(s) if you prefer or leave
the default setting.</p>
<p>Leave the peer_to_peer set to <em>false</em> unless you
want peers to communicate directly with one another, rather than just
with the gateway(s).</p>
<p>The effect of turning on peer to peer is to change
the wireguard <em>AllowedIPs</em> variable to
permit the entire vpn network (<em>/24 or */64</em> for IPv6)
instead of a single IP address for every peer.</p>
<p>Leave it to <em>false</em> to match the example configs at the
given at the end. This is the typical setting.</p>
<p>Never modify the <em>tag</em> field - it is a unique identifier used to
ensure any edits go to the correct place.</p>
<p>Next merge any changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test-info.mods
</pre></div>
</div>
<p>You can make changes at any time using the <em>–edit</em> option
which saves a then current version to the file.</p>
<p>You can change this at any time using <em>wg-tool –edit vpn-test</em>,
modify the setting and <em>-merge</em> the changes back.</p>
</section>
<section id="add-gatewway-wg-a">
<h4>Add Gatewway wg-A<a class="headerlink" href="#add-gatewway-wg-a" title="Link to this heading">¶</a></h4>
<p>Next we add the gateway and some clients. The tool handles all keys and
internal vpn IP addresses.</p>
<p>We’ll use an <em>account</em> called <em>servers</em> with one gateway profile, <em>wg-A</em>.</p>
<p>So now do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--new<span class="w"> </span>vpn-test.servers.wg-A
wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>Edit the file, filename is displayed. In this case
it will be <em>Edits/vpn-test.servers.wg-A.mods</em>.</p>
<p>Since every gateway must be reachable, an <em>Endpoint</em> is required.
We also want to provide access to Office A’s internal LAN.</p>
<p><em>wg-A</em> has access to an internal network which we will
allow it to share with other peers. We do this by
setting the <em>internet_offered</em> with the network. This
can be a list of networks, but we are only providing
access to one.</p>
<p>This means we need to modify a few lines as shown:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_A.example.com:51820&quot;
internet_offered = true
internet_wanted = false
nets_offered = [&quot;192.168.1.0/24&quot;]
post_up = [&#39;/usr/bin/nft -f /etc/wireguard/scripts/postup.nft&#39;]
post_down = [&#39;/usr/bin/nft flush ruleset&#39;]
</pre></div>
</div>
<p>The <em>post_up/down</em> are scripts wireguard runs bringing vpn tunnel up/down.
The nftables rules allow traffic to be NAT’d to and from the tunnel.
If you wish, you can add another DNS server here as well (dns=..).</p>
<p>As we did with vpn edits, merge these changes back using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-A.mods
</pre></div>
</div>
<p>At this point there will be a wireguard config for <em>wg-A</em> in</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Data-wg/vpn-test/servers/wg-A.conf
</pre></div>
</div>
<p>It will have an <em>Interface</em> section but no peers, since we haven’t yet created
anything else beside the one gateway.</p>
</section>
<section id="add-3-clients-peers">
<h4>Add 3 Clients Peers<a class="headerlink" href="#add-3-clients-peers" title="Link to this heading">¶</a></h4>
<p>Now we’re ready to add some client profiles.</p>
<p>We create 3 users where eech user has one profile named <em>laptop</em>.
We choose <em>user-1</em>, <em>user-2</em> and <em>user-3</em> for the 3 account names.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-new<span class="w"> </span>vpn-test.user-1.laptop<span class="w"> </span>vpn-test.user-2.laptop<span class="w"> </span>vpn-test.user-3.laptop
</pre></div>
</div>
</section>
<section id="making-lan-network-available-to-clients">
<h4>Making LAN Network Available to Clients<a class="headerlink" href="#making-lan-network-available-to-clients" title="Link to this heading">¶</a></h4>
</section>
<section id="split-routing">
<h4>Split Routing<a class="headerlink" href="#split-routing" title="Link to this heading">¶</a></h4>
<p>Lets also make user-3.latpop use split routing</p>
<p>By default the laptop clients route all their traffic via the gateway - both
for LAN as well as internet traffic.</p>
<p>Lets edit <em>vpn-test.client-3:laptop</em> to change it to split rouing..
This means LAN traffic will be routed via the vpn and all
regular internet traffic is routed directly.</p>
<p>As usual edit the ID:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.user-3.laptop
</pre></div>
</div>
<p>and modify the file ./Edits/vpn-test.user-3.laptop.mods:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>internet_wanted = false
</pre></div>
</div>
<p>Then merge the change back. The <em>edit</em> option always prints the filename to be edited and merged:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.user-3.laptop.mods
</pre></div>
</div>
</section>
<section id="network-access">
<h4>Network Access<a class="headerlink" href="#network-access" title="Link to this heading">¶</a></h4>
<p><em>wg-A</em> is offering to share its’ LAN, <em>192.168.1.0/24</em>. We now
confgure each of the user laptop configs to request
access to it.</p>
<p>We could use <em>–edit</em> for each of the IDs to accomplish this.
Here we would set the variable <em>nets_wanted = [“192.168.1.0/24”]</em>
for each and then use <em>–merge</em> again.</p>
<p>Alternatively, we can use a command line option, which for this
change is a little easier to do.</p>
<p>Lets use the command line option
to assign network access for each of the clients.</p>
<p>We will permission user-1.laptop and user-2.laptop with
access to <em>192.168.1.0/24</em>.</p>
<p>And, for fun, we limit user-3.laptop to the subnet <em>19.168.1.32/28</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.1.0/24&quot;</span><span class="w"> </span>vpn-test.user-1.laptop<span class="w"> </span>vpn-test.user-2.laptop
wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.1.32/28&quot;</span><span class="w"> </span>vpn-test.user-3.laptop
</pre></div>
</div>
<p>We’re done.</p>
</section>
<section id="listing-what-we-have">
<h4>Listing What We Have<a class="headerlink" href="#listing-what-we-have" title="Link to this heading">¶</a></h4>
<p>We can show everything looks good by using <em>–list</em> (or <em>-l</em>) option.</p>
<p>You can add <em>-v</em> or <em>-vv</em> to get more verbose output.
Using <em>-lv</em> will also show networks while <em>-lvv</em> will show public keys
and any <em>hidden</em> items. You can also filter what is shown by
&lt;vpn&gt;.&lt;account&gt; to show all profiles or &lt;vpn&gt;.&lt;account&gt;.&lt;profile&gt;</p>
<p>For example,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>And the output should look similar to this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Loading vpn-test
 ✓ vpn-test         250914-202654:

     ✓ servers      250914-202654:
                      ✓ wg-A                 250914-202702 (gateway)
                              nets_offered : [&#39;192.168.1.0/24&#39;, &#39;internet&#39;]

     ✓ user-1       250914-202655:
                      ✓ laptop               250914-202702
                               nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;internet&#39;]

     ✓ user-2       250914-202655:
                      ✓ laptop               250914-202702
                               nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;internet&#39;]

     ✓ user-3       250914-202655:
                      ✓ laptop               250914-202702
                               nets_wanted : [&#39;192.168.1.32/28&#39;]
</pre></div>
</div>
<p>The date/times are the last modification time.
The terminal output may show some ascii colors.</p>
<p>All being well, this will show 1 vpn (<em>vpn-test</em>) with 1 gateway under servers.wg-A.
It should also show 3 users each with a laptop profile.</p>
</section>
<section id="wireguard-config-files">
<h4>Wireguard Config Files<a class="headerlink" href="#wireguard-config-files" title="Link to this heading">¶</a></h4>
<p>The standard wireguard config files are all saved under the <em>Data-wg</em> directory.</p>
<p>In our case the configs files are under <em>Data-wg/vpn-test/</em>.
The config for the <em>wg-A</em> gateway will be in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Data-wg/vpn-test/servers/wg-A.conf
</pre></div>
</div>
<p>while client-1 will be under</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Data-wg/vpn-test/user-1/laptop.conf
</pre></div>
</div>
<p>and similarly for the other 2 clients.</p>
<p>All being well, these wireguard config files will match those we showed at in the next section.</p>
</section>
<section id="configs-as-qr-code">
<h4>Configs as QR Code<a class="headerlink" href="#configs-as-qr-code" title="Link to this heading">¶</a></h4>
<p>For non-gatways, a QR code version of the same config is generated under each
account’s <em>qr</em> directory. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat Data-wg/vpn-test/user-1/laptop.conf
Data-wg/vpn-test/user-1/qr/laptop.png
</pre></div>
</div>
<p>You will also see that every pair of peers has it’s own unique pre-shared key.
This is used for all communications between those peers and
adds additional security against post-quantum attacks.</p>
<p>The PSK shared between a gateway and a client will be in the gateway config
in the <em>Peer</em> section for the client and the same key will be in the
client config in the <em>Peer</em> section for that gateway.</p>
<p>These all have both IPv4 as well as IPv6 tunnel addresses automatically generated. We
skipped when listing the configs at the begining of this example.</p>
<p>Wireguard client apps usually can take either the text <em>.conf</em> file or use a
camera to read the QR code.
The QR code has exactly the same information as the corresponding <em>.conf</em> file.</p>
<p>You can view the QR image and see the content of a QR code using, for example <a class="footnote-reference brackets" href="#zbar" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zbarimg<span class="w"> </span>--raw<span class="w"> </span>Data-wg/vpn-test/user-1/qr/laptop.png
</pre></div>
</div>
<p>This displays the same data as the config, without any comments which we
stripped out before building the QR code.</p>
</section>
</section>
<section id="standard-wireguard-configs">
<span id="example-1-standard"></span><h3>Standard Wireguard Configs<a class="headerlink" href="#standard-wireguard-configs" title="Link to this heading">¶</a></h3>
<p>Taken from <em>Data-wg/…</em>.</p>
<p>Note that leading whitespace should not be used in actual config files.
In this document we added extra white space to the output configs solely
to aid in visually separating the sections from one another.</p>
<p><strong>wg-A</strong></p>
<ul class="simple">
<li><p>cat Data-wg/vpn-test/servers/wg-A.conf</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset


#
# Clients
#

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.32/28, fc00:77:77::4/128
</pre></div>
</div>
<p><strong>user-1</strong></p>
<ul class="simple">
<li><p>cat Data-wg/vpn-test/user-1/laptop.conf</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<ul class="simple">
<li><p>cat Data-wg/vpn-test/user-2/laptop.conf</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<ul class="simple">
<li><p>cat Data-wg/vpn-test/user-3/laptop.conf</p></li>
<li><p>using split routing</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.32/28, fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="valid-names" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Valid names comprise letters, numbers and = - _  ~ + ; : &#64;</p>
</aside>
<aside class="footnote brackets" id="zbar" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>zbarimg provided by the <em>zbar</em> package.</p>
</aside>
<aside class="footnote brackets" id="rfc3442" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3442">https://datatracker.ietf.org/doc/html/rfc3442</a></p>
</aside>
</aside>
</section>
</section>
<section id="working-example-2">
<span id="example-2"></span><h2>Working Example 2<a class="headerlink" href="#working-example-2" title="Link to this heading">¶</a></h2>
<p>This example builds on <a class="reference internal" href="#example-1"><span class="std std-ref">Working Example 1</span></a> by adding second gateway.</p>
<p>The new gateway <em>wg-B</em> provides access to Office-B LAN, <em>192.168.2.0/24</em>.
Both gateways provide internet access and are visible on the internet.</p>
<p><em>wg-A</em> still offers access to  Office A LAN.</p>
<p>We walk through the steps <a class="reference internal" href="#example-2-tool"><span class="std std-ref">Generating the Wireguard Configs Using wg-tool</span></a> which leads to the
creation of the <a class="reference internal" href="#example-2-standard"><span class="std std-ref">Standard Wireguard Configs</span></a>.</p>
<section id="id4">
<h3>Network Diagram<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<a class="reference internal image-reference" href="_images/Example-2.png"><img alt="Example 2" class="align-center" src="_images/Example-2.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p>user-1 and user-2’s laptops can connect to both gateways and
access both LANs. Their internet traffic will go through the vpn, providing
privacy. Their internet access could be one or the other gateway.</p>
<p>Note that wireguard relies on the networks shown in the config files
to set up routing. It does not check nor provide a failover mechanism
or any dynamic checks and adjustments.</p>
<p>In practice wireguard chooses the first peer offering a route to the internet
and stick with that. This happens when wireguard starts.</p>
<p>user-3 continues to use split routing, retaining direct internet access and using
the gateways solely for LAN access to both office locations.</p>
<p>As in the previous example, we construct the goals table:</p>
</section>
<section id="id5">
<h3>Goals Table<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<table class="docutils align-default" id="id15">
<caption><span class="caption-text">Example 2 Goals</span><a class="headerlink" href="#id15" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>servers</p></td>
<td><p>wg-B</p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p>192.168.2.0/24</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-odd"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example-2-tool">
<span id="id6"></span><h3>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#example-2-tool" title="Link to this heading">¶</a></h3>
<p>Next we create the wireguard configs above using wg-tool.
This will be quit a bit simpler than editing all those configs manually.</p>
<p>We build on what was done in Part 1 working in the same directory.</p>
<section id="add-second-gateway-wg-b">
<h4>Add Second Gateway wg-B<a class="headerlink" href="#add-second-gateway-wg-b" title="Link to this heading">¶</a></h4>
<p>Lets add the new gateway <em>wg-B</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--new<span class="w"> </span>vpn-test.servers.wg-B
wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-B
</pre></div>
</div>
<p>Edit the file as displayed, this time it will be <em>Edits/vpn-test.servers.wg-B.mods</em>.</p>
<p>As we did for <em>wg-A</em>, add an Endpoint for <em>wg-B</em>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_B.example.net:51820&quot;]
internet_offered = true
post_up = [&#39;/usr/bin/nft -f /etc/wireguard/scripts/postup.nft&#39;]
post_down = [&#39;/usr/bin/nft flush ruleset&#39;]
</pre></div>
</div>
<p>As before merge the changes back:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-B.mods
</pre></div>
</div>
</section>
<section id="id7">
<h4>Network Access<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<p>First lets set <em>wg-B</em> to offer Ofice B LAN network, <em>192.168.2.0/24</em>, and
also give it access to the LAN offered by <em>wg-A</em> network.</p>
<p>We’ll also give <em>wg-A</em> access to this network, <em>192.168.2.0/24</em>.</p>
<p>I other words, each of the 2 gateways will have access to the LAN provided
by the other gateway.</p>
<p>Lets use the command line options to accomplish this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-offered-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-B
wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.1.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-B

wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>Next we add permission to <em>192.168.2.0/24</em> for all 3 user profiles.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-wanted-add<span class="w"> </span><span class="s2">&quot;192.168.2.0/24&quot;</span><span class="w"> </span>vpn-test.user-1<span class="w"> </span>vpn-test.user-2<span class="w"> </span>vpn-test.user-3
</pre></div>
</div>
<p>Notice that we used <em>&lt;vpn&gt;.&lt;account&gt;</em> for the user IDs. This is a shortcut for every profile
belonging to <em>&lt;vpn&gt;.&lt;account&gt;</em>. In our case each user only has a single profile, laptop.
If there were more then, every profile would have this network added.</p>
<p>You can add multiple networks using <em>–nets-wanted-add</em> by separating them with commas.
For example you can use “102.168.2.0/24,192.168.100.0/24” to add 2 networks.</p>
</section>
<section id="id8">
<h4>Listing What We Have<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h4>
<p>As we did in previous example, lets list everthing to confirm it has what we want.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>Output should look similar to this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>✓ vpn-test         250915-065904:

    ✓ servers      250915-093519:
                     ✓ wg-A                 250915-093526 (gateway)
                                     nets_offered : [&#39;192.168.1.0/24&#39;, &#39;internet&#39;]
                                      nets_wanted : [&#39;192.168.2.0/24&#39;]
                     ✓ wg-B                 250915-093526 (gateway)
                                     nets_offered : [&#39;192.168.2.0/24&#39;, &#39;internet&#39;]
                                      nets_wanted : [&#39;192.168.1.0/24&#39;]

    ✓ user-1       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;192.168.2.0/24&#39;, &#39;internet&#39;]

    ✓ user-2       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.0/24&#39;, &#39;192.168.2.0/24&#39;, &#39;internet&#39;]

    ✓ user-3       250915-065905:
                     ✓ laptop               250915-093526
                                      nets_wanted : [&#39;192.168.1.32/28&#39;, &#39;192.168.2.0/24&#39;]
</pre></div>
</div>
<p>This shows both gateways sharing one another’s networks
and the users have also gained access to <em>192.168.2.0/24</em></p>
<p><em>vpn-test.user-3.laptop</em> is still using split tunnelling.</p>
<p>As before, the resulting wireguard config files reside
under <em>Data-wg/vpn-test1</em>.</p>
<p>By now you may feel the list output above is sufficient to confirm things
are as intended, but for completeness we’ll show the resulting wireguard
configs, as we did in the previous example.</p>
<p>The config for the 2 gateways <em>wg-A</em> and <em>wg-B</em> will be in:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-A.conf
cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-B.conf
</pre></div>
</div>
<p>while the 3 user acoounts and their laptop profiles will be found:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat Data-wg/vpn-test/user-1/laptop.conf
cat Data-wg/vpn-test/user-2/laptop.conf
cat Data-wg/vpn-test/user-3/laptop.conf
</pre></div>
</div>
<p>These files should match what is shown below.</p>
</section>
</section>
<section id="example-2-standard">
<span id="id9"></span><h3>Standard Wireguard Configs<a class="headerlink" href="#example-2-standard" title="Link to this heading">¶</a></h3>
<p><strong>wg-A</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::5/128
    Endpoint             = vpn_B.example.com:51820

#
# Clients
#

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.0/24, fc00:77:77::4/128
</pre></div>
</div>
<p><strong>wg-B</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-B (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.5/24, fc00:77:77::5/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-B x wg-A&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820

#
# Clients
#

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.2.0/24, fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.2.0/24, fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-B x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.2.0/24, fc00:77:77::4/128
</pre></div>
</div>
<p><strong>user-1</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.5/32, 192.168.2.0/24
    # pre-compacted        ::/0, fc00:77:77::5/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-2.laptop&gt;
    # re-compacted        0.0.0.0/0, 10.77.77.5/32, 192.168.2.0/24
    # re-compacted        ::/0, fc00:77:77::5/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#
[Peer]               # servers wg-B (gateway)
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-B x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.2.0/24, fc00:77:77::5/128
    Endpoint             = vpn_B.example.com:51820

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
</section>
</section>
<section id="working-example-3">
<h2>Working Example 3<a class="headerlink" href="#working-example-3" title="Link to this heading">¶</a></h2>
<p>This example makes one small modification to <a class="reference internal" href="#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
<p><em>wg-B</em> is changed to be a client instead of a gateway.</p>
<p>This means it no longer has its own <em>Endpoint</em>.
It continues to offer access to the Office B LAN but now
provides it to <em>wg-A</em> which in turn will share it with it’s clients.</p>
<p>This situation can occur when there are 2 locations, one of them
has a public IP address (<em>wg-A</em>) while the other one (<em>wg-B</em>) does not.
Now <em>wg-B</em> can connect to <em>wg-A</em> as a client, providing access to it’s LAN,
while <em>wg-A</em> offers its LAN to <em>wg-B</em>.</p>
<p>The road warrier laptops can only connect to <em>wg-A</em> and they all
want to have access to both LANs.</p>
<section id="id10">
<h3>Network Diagram<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<a class="reference internal image-reference" href="_images/Example-3.png"><img alt="Example 3" class="align-center" src="_images/Example-3.png" style="width: 408.0px; height: 528.0px;" />
</a>
<p><em>wg-B</em> will be a peer of <em>wg-A</em> and offer access to Office B’s LAN.
However clients will now access this LAN via <em>wq-A</em>.</p>
<p>Simple change to the goals, but quite a few changes to the wireguard configs.</p>
<p>When a gateway offers local networks
it is straightfoward to make them available to clients. In this case, clients need to
be informed that both Office A LAN and Office B LAN are available from gateway <em>wg-A</em>.</p>
<p>As before build the goals table:</p>
</section>
<section id="id11">
<h3>Goals Table<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h3>
<table class="docutils align-default" id="id16">
<caption><span class="caption-text">Example 3: vpn-test</span><a class="headerlink" href="#id16" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>Internet</p></th>
<th class="head"></th>
<th class="head"><p>Networks</p></th>
<th class="head"></th>
</tr>
<tr class="row-even"><th class="head"><p>Account</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>Gateway</p></th>
<th class="head"><p>wanted</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>offered</p></th>
<th class="head"><p>wanted</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-A</p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servers</p></td>
<td><p>wg-B</p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p>192.168.2.0/24</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-1</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-2</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✓ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.0/24</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
<tr class="row-even"><td><p>user-3</p></td>
<td><p>laptop</p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p> ✗ </p></td>
<td><p>-</p></td>
<td><p>192.168.1.32/28</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>192.168.2.0/24</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id12">
<h3>Generating the Wireguard Configs Using wg-tool<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h3>
<p>As in the previous two examples, we create the wireguard configs
using wg-tool. We are going to make a small edit to <em>wg-B</em> to achieve this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--edit<span class="w"> </span>vpn-test.servers.wg-B
</pre></div>
</div>
<p>Edit the file as before, (<em>Edits/vpn-test.servers.wg-B.mods</em>).
The only change needed is to set <em>Endpoint</em> to an empty string
and change <em>internet_offered</em> to false</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;&quot;
internet_offered = false
</pre></div>
</div>
<p>Merge the changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--merge<span class="w"> </span>Edits/vpn-test.servers.wg-B.mods
</pre></div>
</div>
<p>Since <em>wg-B</em> can no longer provide access to other clients, we let <em>wg-A</em>
do that on it’s behalf:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>--nets-offered-add<span class="w">  </span><span class="s1">&#39;192.168.2.0/24&#39;</span><span class="w"> </span>vpn-test.servers.wg-A
</pre></div>
</div>
<p>That should be all that is necessary, <em>wg-tool</em> will do the rest.</p>
<p>List what we have:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wg-tool<span class="w"> </span>-lv
</pre></div>
</div>
<p>The only real difference in the listing is that <em>wg-B</em> is no longer showing
as a gateway. It isn’t of course, its just another peer at this point.
However, it still provides access to the <em>192.168.2.0/24</em> network.</p>
<p>Here’s a terminal screen shot of the output:</p>
<a class="reference internal image-reference" href="_images/Example-3-list.png"><img alt="Example 3" class="align-center" src="_images/Example-3-list.png" style="width: 858.0px; height: 553.0px;" />
</a>
<p>As you can see in the verbose list output, <em>wg-B</em> is no longer a gateway. It offers
access to Office B LAN as a client to <em>wg-A</em>. It also <em>wants</em> access to Office A LAN.</p>
<p>All laptops want access to both networks which they now get from <em>wg-A</em>.</p>
<p>If you look at the wireguard configs you will see that the laptops now get both
networks from <em>wg-A</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-A.conf
cat<span class="w"> </span>Data-wg/vpn-test/servers/wg-B.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-1/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-2/laptop.conf
cat<span class="w"> </span>Data-wg/vpn-test/user-3/laptop.conf
</pre></div>
</div>
<p>You will see that <em>wg-B</em> now has just one peer which is <em>wg-A</em>.
Furthermore, <em>wg-A</em> now allows <em>192.168.1.0/24</em> as well as <em>192.168.2.0/24</em> to it’s
clients. Finally, all the laptop clients now have both LANs listed in each
<em>AllowedIPs</em> with <em>wg-A</em>.</p>
<p>Previously, each laptop had LAN A listed for <em>wg-A</em> and LAN B for <em>wg-B</em>.</p>
<p>If we want to go back with <em>wg-B</em> again being a full gateway, then we just
edit <em>wg-B</em> and restore it’s Endpoint and, if desired,  allow it to offer
internet access as well.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Endpoint = &quot;vpn_B.example.net:51820&quot;
internet_offered = true
</pre></div>
</div>
<p>Merge changes back and everything is back to the way it was in <a class="reference internal" href="#example-2"><span class="std std-ref">Working Example 2</span></a>.</p>
</section>
<section id="example-3-standard">
<span id="id13"></span><h3>Standard Wireguard Configs<a class="headerlink" href="#example-3-standard" title="Link to this heading">¶</a></h3>
<p>The basic set up is same as example 2. The only thing we’re changing, at
least superficially, is that <em>wg-B</em> is no longer a gateway; it’s now another client.</p>
<p>This alsop means other client configs must be changed that they know to access
Office B LAN from <em>wg-A</em> instead of <em>wg-B</em>, as before.</p>
<p>We must also change <em>wg-B</em> to remove the Endpoint while still offering
LAN-B access.</p>
<p><strong>wg-A</strong></p>
<ul class="simple">
<li><p>Note that the Peer section for <em>wg-B</em> no longer has an Endpoint</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-A (gateway)
    PrivateKey           = &lt;privkey&gt;
    ListenPort           = 51820
    Address              = 10.77.77.1/24, fc00:77:77::1/64
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset


#
# Clients
#

[Peer]               # servers wg-B
    PublicKey            = &lt;pubkey wg-B&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.5/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::5/128

[Peer]               # user-1 laptop
    PublicKey            = &lt;pubkey user-1.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    AllowedIPs           = 10.77.77.2/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::2/128

[Peer]               # user-2 laptop
    PublicKey            = &lt;pubkey user-2.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    AllowedIPs           = 10.77.77.3/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::3/128

[Peer]               # user-3 laptop
    PublicKey            = &lt;pubkey user-3.laptop&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.4/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::4/128
</pre></div>
</div>
<p><strong>wg-B</strong></p>
<ul class="simple">
<li><p>Client not a gateway</p></li>
<li><p>ListenPort is removed from the Interface section,</p></li>
<li><p>provides access to LAN B</p></li>
<li><p>there are no longer any user laptop sections</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # servers wg-B
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.5/32, fc00:77:77::5/128
    DNS                  = 10.10.10.10
    PostUp               = /usr/bin/nft -f /etc/wireguard/scripts/postup.nft
    PostDown             = /usr/bin/nft flush ruleset

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x wg-B&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.0/24, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-1</strong></p>
<ul class="simple">
<li><p>Note <em>wg-B</em> has been removed from all laptop clients and Office B LAN now provided by <em>wg-A</em></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-1 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.2/32, fc00:77:77::2/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-1.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-2</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-2 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.3/32, fc00:77:77::3/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-2.laptop&gt;
    # pre-compacted        0.0.0.0/0, 10.77.77.1/32, 192.168.1.0/24
    # pre-compacted        192.168.2.0/24, ::/0, fc00:77:77::1/128
    AllowedIPs           = 0.0.0.0/0, ::/0
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
<p><strong>user-3</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Interface]          # user-3 laptop
    PrivateKey           = &lt;privkey&gt;
    Address              = 10.77.77.4/32, fc00:77:77::4/128
    DNS                  = 10.10.10.10

#
# Gateways
#

[Peer]               # servers wg-A (gateway)
    PublicKey            = &lt;pubkey wg-A&gt;
    PresharedKey         = &lt;psk wg-A x user-3.laptop&gt;
    AllowedIPs           = 10.77.77.1/32, 192.168.1.32/28, 192.168.2.0/24
    AllowedIPs           = fc00:77:77::1/128
    Endpoint             = vpn_A.example.com:51820
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">wg_tool</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">wg-tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#getting-started">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="License/License.html">License</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#where-to-run-the-gateway">Where to Run The Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-example-1">Working Example 1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#network-diagram">Network Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="#goals-table">Goals Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-the-wireguard-configs-using-wg-tool">Generating the Wireguard Configs Using wg-tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#make-working-directory">Make Working Directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-new-vpn-called-vpn-test">Make New VPN called vpn-test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-gatewway-wg-a">Add Gatewway wg-A</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-3-clients-peers">Add 3 Clients Peers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#making-lan-network-available-to-clients">Making LAN Network Available to Clients</a></li>
<li class="toctree-l4"><a class="reference internal" href="#split-routing">Split Routing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-access">Network Access</a></li>
<li class="toctree-l4"><a class="reference internal" href="#listing-what-we-have">Listing What We Have</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wireguard-config-files">Wireguard Config Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configs-as-qr-code">Configs as QR Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#standard-wireguard-configs">Standard Wireguard Configs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#working-example-2">Working Example 2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Network Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Goals Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-2-tool">Generating the Wireguard Configs Using wg-tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#add-second-gateway-wg-b">Add Second Gateway wg-B</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Network Access</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Listing What We Have</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-2-standard">Standard Wireguard Configs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#working-example-3">Working Example 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">Network Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">Goals Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Generating the Wireguard Configs Using wg-tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-3-standard">Standard Wireguard Configs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Editing.html">Editing and Making Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Options.html">Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Completion.html">Command Line Bash Completion</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Reports.html">Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Key-rollover.html">Key Rollover</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Helper-scripts.html">Convenience Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Migrating.html">Migrating from Earlier Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Import.html">Importing From Standard Wireguard Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Directory-structure.html">Directory and File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sections/Appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contrib/ubuntu.html">Contrib</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="License/License.html" title="previous chapter">License</a></li>
      <li>Next: <a href="Sections/Editing.html" title="next chapter">Editing and Making Changes</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022-2025, Gene C.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/Examples.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>